id: f3ffdd5a-cb43-4da3-9036-222cfd294a2c
refId: CIS-4.1
type: asset
name: >
  Ensure no security groups allow ingress from 0.0.0.0/0 to port 22
description: >
  Security groups provide stateful filtering of ingress/egress network traffic to AWS
  resources. It is recommended that no security group allows unrestricted ingress access to
  port 22.
severity: high
enabled: true
sql: >
  SELECT arn
  FROM
    (SELECT arn,
            jsonb_array_elements(ingress_rule->'ipRanges') AS ip_ranges
     FROM (awsec2securitygroup AS sg1
           LEFT JOIN
             (SELECT arn AS arn2,
                     jsonb_array_elements(configuration->'ipPermissions') AS ingress_rule
              FROM awsec2securitygroup) ip_permissions ON sg1.arn = ip_permissions.arn2) ingress_rules
     WHERE ((ingress_rules.ingress_rule->>'fromPort')::INT <= 22
            AND (ingress_rules.ingress_rule->>'toPort')::INT >= 22)
       OR ingress_rules.ingress_rule->>'fromPort' IS NULL
       OR ingress_rules.ingress_rule->>'toPort' IS NULL ) tmp_query
  WHERE ip_ranges->>'cidrIp' = '0.0.0.0/0' ;
remediation: >
  Perform the following to implement the prescribed state:
    1. Login to the AWS Management Console at
    https://console.aws.amazon.com/vpc/home
    2. In the left pane, click Security Groups
    3. For each security group, perform the following:
    4. Select the security group
    5. Click the Inbound Rules tab
    6. Identify the rules to be removed
    7. Click the x in the Remove column
    8. Click Save
remediationDocURLs:
  - https://docs.openraven.com/remediations/ensure_limited_SSH_ingress
version: 0.1.3
